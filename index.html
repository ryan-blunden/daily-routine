<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daily Routine Planner</title>
    <link rel="icon" href="data:," />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Manrope:wght@400;500;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg: #0b0f14;
        --panel: #101722;
        --ink: #eaf0fa;
        --muted: #8fa0b8;
        --line: #1d2938;
        --accent: #37d0ff;
        --accent-2: #4bffbe;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        background: var(--bg);
        font-family: "Manrope", sans-serif;
        color: var(--ink);
      }

      .stage {
        min-height: 100vh;
        display: grid;
        place-items: center;
        padding: 24px;
      }

      .page {
        width: min(980px, 92vw);
        background: var(--panel);
        border: 1px solid #263547;
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.55);
        padding: 46px;
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 30px;
        position: relative;
        overflow: hidden;
      }

      .page::after {
        content: "";
        position: absolute;
        inset: 0;
        background-image: linear-gradient(rgba(255, 255, 255, 0.004) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 255, 255, 0.004) 1px, transparent 1px);
        background-size: 18px 18px;
        pointer-events: none;
      }

      .header {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: start;
        gap: 4mm;
        border-bottom: 1px solid var(--line);
        padding-bottom: 4mm;
      }

      .title {
        font-family: "Bebas Neue", sans-serif;
        letter-spacing: 0.08em;
        font-size: 13mm;
        line-height: 0.9;
        margin: 0;
      }

      .title strong {
        color: var(--accent);
      }

      .today-date {
        margin: 1.5mm 0 0 0;
        min-width: 60mm;
        text-align: right;
        font-size: 9pt;
        letter-spacing: 0.05em;
        color: var(--muted);
      }

      .status-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2.2mm;
      }

      .status-card {
        border: 1px solid var(--line);
        border-left: 3px solid var(--accent);
        border-radius: 2mm;
        padding: 2.4mm;
      }

      .status-card b {
        display: block;
        font-size: 8pt;
        letter-spacing: 0.07em;
        color: var(--muted);
        margin-bottom: 1.4mm;
        text-transform: uppercase;
      }

      .status-card i {
        display: block;
        border-bottom: 1px solid var(--line);
        height: 4.7mm;
      }

      .status-card .metric {
        font-size: 11pt;
        font-weight: 700;
        color: var(--ink);
        letter-spacing: 0.02em;
      }

      .schedule {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        column-gap: 5.2mm;
        row-gap: 5.2mm;
        align-content: start;
      }

      .block {
        border: 1px solid var(--line);
        border-radius: 2.5mm;
        padding: 2.8mm 3mm;
        background: rgba(255, 255, 255, 0.015);
        margin: 0;
        height: 45mm;
        display: flex;
        flex-direction: column;
      }

      .block h2 {
        margin: 0 0 0.6mm 0;
        min-height: 4.8mm;
        font-size: 7.7pt;
        line-height: 1.2;
        letter-spacing: 0.07em;
        text-transform: uppercase;
        color: var(--accent);
      }

      .block .time {
        margin: 0 0 0.8mm 0;
        min-height: 3.1mm;
        font-size: 6.9pt;
        color: var(--muted);
        letter-spacing: 0.06em;
      }

      .block .desc {
        margin: 0 0 1.1mm 0;
        min-height: 3.2mm;
        font-size: 6.7pt;
        color: #ffffff;
        letter-spacing: 0.01em;
      }

      ul {
        list-style: none;
        margin: 2mm 0 0 0;
        padding: 0;
        display: grid;
        gap: 1.1mm;
      }

      li:nth-child(n + 5) {
        display: none;
      }

      li {
        display: grid;
        grid-template-columns: 3.5mm 1fr;
        gap: 2mm;
        align-items: start;
        font-size: 7pt;
        line-height: 1.35;
        padding: 0.4mm 0;
        cursor: pointer;
      }

      li input[type="checkbox"] {
        appearance: none;
        width: 3.2mm;
        height: 3.2mm;
        margin-top: 0.25mm;
        border: 1px solid var(--line);
        border-radius: 0.8mm;
        background: rgba(255, 255, 255, 0.02);
      }

      li input[type="checkbox"]:checked {
        border-color: var(--accent);
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        box-shadow: 0 0 0 1px rgba(11, 15, 20, 0.45) inset;
      }

      li .task-text.done {
        color: var(--muted);
        text-decoration: line-through;
      }

      @media (max-width: 980px) {
        .page {
          padding: 34px;
          gap: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="stage">
      <main class="page">
        <header class="header">
          <h1 class="title" id="planner-title">DAILY <strong>SETLIST</strong></h1>
          <p class="today-date" id="today-date"></p>
        </header>

        <section class="status-row" aria-label="Daily status">
          <article class="status-card"><b>Tasks Done</b><span class="metric" id="tasks-done">0/0</span></article>
          <article class="status-card"><b>Completion</b><span class="metric" id="tasks-percent">0%</span></article>
          <article class="status-card"><b>Blocks Cleared</b><span class="metric" id="blocks-done">0/0</span></article>
        </section>

        <section class="schedule" aria-label="Routine schedule" id="schedule"></section>

      </main>
    </div>
  </body>
  <script>
    (async () => {
      const STORAGE_PREFIX = "daily-setlist-state-v1:";
      const titleEl = document.getElementById("planner-title");
      const todayDateEl = document.getElementById("today-date");
      const scheduleEl = document.getElementById("schedule");
      const doneEl = document.getElementById("tasks-done");
      const percentEl = document.getElementById("tasks-percent");
      const blocksDoneEl = document.getElementById("blocks-done");

      const toLocalISODate = (d) => {
        const off = d.getTimezoneOffset();
        const local = new Date(d.getTime() - off * 60000);
        return local.toISOString().slice(0, 10);
      };

      const slug = (s) =>
        s
          .toString()
          .toLowerCase()
          .replace(/&/g, "and")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "");

      const unquote = (s) => {
        if (!s) return "";
        const q = s.trim();
        if (q.startsWith('"') && q.endsWith('"')) {
          return q
            .slice(1, -1)
            .replace(/\\"/g, '"')
            .replace(/\\\\/g, "\\");
        }
        return q;
      };

      const parseTomlValue = (raw) => {
        const value = raw.trim();
        if (value.startsWith("[") && value.endsWith("]")) {
          const inner = value.slice(1, -1).trim();
          if (!inner) return [];
          const matches = inner.match(/"((?:\\"|[^"])*)"/g) || [];
          return matches.map((m) => unquote(m));
        }
        if (value === "true") return true;
        if (value === "false") return false;
        if (/^-?\d+(\.\d+)?$/.test(value)) return Number(value);
        return unquote(value);
      };

      const parseTomlPlanner = (toml) => {
        const data = { blocks: [] };
        let currentBlock = null;
        const lines = toml.split(/\r?\n/);
        for (let i = 0; i < lines.length; i += 1) {
          const rawLine = lines[i];
          const line = rawLine.replace(/\s+#.*$/, "").trim();
          if (!line) continue;
          if (line === "[[blocks]]") {
            currentBlock = { title: "", time: "", items: [] };
            data.blocks.push(currentBlock);
            continue;
          }
          const match = line.match(/^([A-Za-z0-9_-]+)\s*=\s*(.+)$/);
          if (!match) continue;
          const [, key, initialRawValue] = match;
          let rawValue = initialRawValue;

          if (rawValue.trim().startsWith("[") && !rawValue.trim().endsWith("]")) {
            const parts = [rawValue];
            while (i + 1 < lines.length) {
              i += 1;
              const nextLine = lines[i].replace(/\s+#.*$/, "").trim();
              if (!nextLine) continue;
              parts.push(nextLine);
              if (nextLine.endsWith("]")) break;
            }
            rawValue = parts.join(" ");
          }

          const target = currentBlock || data;
          target[key] = parseTomlValue(rawValue);
        }
        return data;
      };

      const normalizePlannerData = (raw) => {
        const blocks = Array.isArray(raw?.blocks)
          ? raw.blocks.map((b) => ({
              title: String(b?.title || ""),
              time: String(b?.time || ""),
              description: String(b?.description || ""),
              items: Array.isArray(b?.items) ? b.items.map((i) => String(i)) : []
            }))
          : [];

        return {
          titlePrefix: String(raw?.title_prefix || "DAILY"),
          titleAccent: String(raw?.title_accent || "SETLIST"),
          blocks
        };
      };

      const fetchText = async (path) => {
        const res = await fetch(path, { cache: "no-store" });
        if (!res.ok) throw new Error(`Unable to load ${path}`);
        return res.text();
      };

      const loadPlannerData = async () => {
        try {
          const tomlText = await fetchText("planner-data.toml");
          return normalizePlannerData(parseTomlPlanner(tomlText));
        } catch (_) {
          const jsonText = await fetchText("planner-data.json");
          return normalizePlannerData(JSON.parse(jsonText));
        }
      };

      const setHeaderTitle = (titlePrefix, titleAccent) => {
        titleEl.textContent = "";
        titleEl.append(document.createTextNode(`${titlePrefix} `));
        const accent = document.createElement("strong");
        accent.textContent = titleAccent;
        titleEl.append(accent);
      };

      const renderDescriptionHtml = (el, html) => {
        const template = document.createElement("template");
        template.innerHTML = String(html || "");
        const allowedTags = new Set(["B", "STRONG", "I", "EM", "U", "SMALL", "CODE", "BR", "SPAN", "A"]);
        const walker = document.createTreeWalker(template.content, NodeFilter.SHOW_ELEMENT);
        const replaceWithText = [];

        while (walker.nextNode()) {
          const node = walker.currentNode;
          const tag = node.tagName;
          if (!allowedTags.has(tag)) {
            replaceWithText.push(node);
            continue;
          }

          [...node.attributes].forEach((attr) => {
            const name = attr.name.toLowerCase();
            const value = attr.value.trim();
            const isAnchorAttr = tag === "A" && (name === "href" || name === "target" || name === "rel");
            if (name.startsWith("on")) {
              node.removeAttribute(attr.name);
            } else if (tag === "A" && name === "href" && /^\s*javascript:/i.test(value)) {
              node.removeAttribute("href");
            } else if (!isAnchorAttr && name !== "class") {
              node.removeAttribute(attr.name);
            }
          });

          if (tag === "A") {
            if (!node.getAttribute("target")) node.setAttribute("target", "_blank");
            node.setAttribute("rel", "noopener noreferrer");
          }
        }

        replaceWithText.forEach((node) => {
          node.replaceWith(document.createTextNode(node.textContent || ""));
        });

        el.replaceChildren(template.content.cloneNode(true));
      };

      const renderBlocks = (blocks) => {
        scheduleEl.textContent = "";
        blocks.forEach((block, blockIndex) => {
          const article = document.createElement("article");
          article.className = "block";

          const heading = document.createElement("h2");
          heading.textContent = block.title;

          const time = document.createElement("p");
          time.className = "time";
          time.textContent = block.time;

          const desc = document.createElement("p");
          desc.className = "desc";
          renderDescriptionHtml(desc, block.description);

          const list = document.createElement("ul");
          const cappedItems = block.items.slice(0, 4);
          cappedItems.forEach((item, itemIndex) => {
            const li = document.createElement("li");
            li.setAttribute("role", "group");

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            const taskId = `${blockIndex}-${slug(block.title)}-${itemIndex}`;
            checkbox.dataset.taskId = taskId;
            checkbox.id = `task-${taskId}`;
            checkbox.name = `task-${taskId}`;
            checkbox.setAttribute("aria-label", item);

            const span = document.createElement("span");
            span.className = "task-text";
            span.textContent = item;

            li.append(checkbox, span);
            list.append(li);
          });

          article.append(heading, time, desc, list);
          scheduleEl.append(article);
        });
      };

      const today = toLocalISODate(new Date());
      const todayLabel = new Intl.DateTimeFormat("en-GB", {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric"
      }).format(new Date());
      todayDateEl.textContent = todayLabel;

      const keyForDate = () => STORAGE_PREFIX + today;
      const getCheckboxes = () => [...document.querySelectorAll('li input[type="checkbox"]')];
      const getBlocks = () => [...document.querySelectorAll(".block")];

      const readState = () => {
        const raw = localStorage.getItem(keyForDate());
        if (!raw) return {};
        try {
          return JSON.parse(raw);
        } catch (_) {
          return {};
        }
      };

      const writeState = () => {
        const payload = {};
        getCheckboxes().forEach((cb) => {
          payload[cb.dataset.taskId] = cb.checked;
        });
        localStorage.setItem(keyForDate(), JSON.stringify(payload));
      };

      const updateMetrics = () => {
        const checks = getCheckboxes();
        const total = checks.length;
        const done = checks.filter((cb) => cb.checked).length;
        const percent = total ? Math.round((done / total) * 100) : 0;
        const blocks = getBlocks();
        const blockTotals = blocks.map((b) => {
          const list = [...b.querySelectorAll('input[type="checkbox"]')];
          return list.length && list.every((cb) => cb.checked);
        });
        const blockDone = blockTotals.filter(Boolean).length;

        doneEl.textContent = `${done}/${total}`;
        percentEl.textContent = `${percent}%`;
        blocksDoneEl.textContent = `${blockDone}/${blocks.length}`;

        checks.forEach((cb) => {
          const text = cb.nextElementSibling;
          if (text) text.classList.toggle("done", cb.checked);
        });
      };

      const loadState = () => {
        const state = readState();
        getCheckboxes().forEach((cb) => {
          cb.checked = Boolean(state[cb.dataset.taskId]);
        });
        updateMetrics();
      };

      document.addEventListener("change", (e) => {
        if (e.target.matches('input[type="checkbox"]')) {
          writeState();
          updateMetrics();
        }
      });

      const plannerData = await loadPlannerData();
      setHeaderTitle(plannerData.titlePrefix, plannerData.titleAccent);
      renderBlocks(plannerData.blocks);
      loadState();
    })();
  </script>
</html>
